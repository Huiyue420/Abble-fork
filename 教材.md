# Godot 單一腳本建構 UI 與連線系統教材

這份教材將深入解析為什麼我們只需要一份 `Lobby.gd` 程式碼，就能同時完成「畫面繪製」與「多人連線」的功能。這涉及到了 Godot 引擎的核心運作原理。

---

## 第一章：為何一份程式碼就能產生 UI？

在 Godot 中，我們通常習慣使用編輯器（拖拉節點、設定屬性）來製作介面。但事實上，編輯器所做的一切，在遊戲執行時都會被轉換成程式碼邏輯。

### 1. 節點 (Node) 與 類別 (Class)
Godot 的每一個元件（按鈕、標籤、容器）本質上都是一個 **類別 (Class)**。
*   `Button` 是各個按鈕的類別。
*   `Label` 是文字標籤的類別。
*   `VBoxContainer` 是排列容器的類別。

當我們在程式碼中寫 `Button.new()` 時，就等於在記憶體中創造了一個新的按鈕，這跟你在編輯器裡按「+ 新增節點」是一模一樣的動作。

### 2. 場景樹 (Scene Tree) 的概念
Godot 的遊戲世界是一棵大樹。只有被掛在樹上的節點，才會被看見、被執行。
程式碼中的 `add_child(node)` 指令，就是將我們憑空創造出來的節點，手動掛上去。

**程式碼運作流程：**
1.  **`_ready()`**: 腳本啟動。
2.  **`_setup_ui()`**:
    *   `var btn = Button.new()` -> 在記憶體創造按鈕 (此時畫面上還看不到)。
    *   `btn.text = "Host"` -> 設定它的屬性 (就像在 Inspector 面板打字)。
    *   `add_child(btn)` -> **關鍵一步**！將按鈕掛到場景樹上，這時玩家才看得到它。

### 3. 為什麼要用程式碼寫 UI？ (優缺點)
*   **優點**：高度模組化、複製貼上即可用（像我給您的這個腳本）、不需要依賴額外的 `.tscn` 場景檔、易於製作「動態生成的選單」。
*   **缺點**：無法直觀地預覽（每次修改位置都要執行才看得到）、排版複雜時程式碼會很長。

---

## 第二章：連線系統原理 (ENet)

這份程式碼使用了 Godot 內建的高階多人連線 API (`High-level Multiplayer API`)，底層基於 ENet 協議。

### 1. 核心物件：`ENetMultiplayerPeer`
這是 Godot 用來傳送封包的「郵差」。
*   **Host (房主)**: 執行 `create_server(port)`。他打開家門（Port），等待別人進來。
*   **Join (加入者)**: 執行 `create_client(ip, port)`。他拿著地址（IP）去敲門。

### 2. 訊號 (Signals) 驅動
網路連線是非同步的（你不知道對方什麼時候會連進來），所以我們依賴「訊號」。

| 訊號名稱 | 觸發時機 | 誰會收到？ | 用途 |
| :--- | :--- | :--- | :--- |
| `peer_connected` | 當有人連線成功時 | Server 與其他 Client | 更新玩家列表、生成玩家角色 |
| `peer_disconnected` | 當有人斷線時 | Server 與其他 Client | 移除玩家角色、顯示離開訊息 |
| `connected_to_server` | 當自己成功連上 Server 時 | 僅 Client (加入者) | 切換到遊戲大廳畫面 |
| `connection_failed` | 連線失敗 (IP錯誤/防火牆) | 僅 Client (加入者) | 顯示錯誤訊息 |

---

## 第三章：這份程式可以遠端連線嗎？

**答案是：絕對可以。**

這份程式碼本身**完全具備**遠端連線的能力。程式碼裡的 `create_client(ip, port)` 函式，並不在乎那個 IP 是隔壁房間的電腦，還是地球另一端的電腦。

**但是，現實網路環境有阻礙。**

### 1. 為什麼不能直接連？ (NAT 問題)
大多數家用電腦都沒有「真實的公網 IP」，而是躲在路由器（WiFi 分享器）後面的「虛擬 IP」(通常是 `192.168.x.x`)。
*   **情況**：朋友輸入您的 `192.168.1.5`。
*   **結果**：網際網路不知道這是誰，因為全世界有幾百萬台電腦都叫 `192.168.1.5`。

### 2. 解決方案 (如何實現遠端連線)

若您想用這份程式碼跟不同住處的朋友連線，不需要改程式碼，而是需要改變「連線方式」：

#### 方法 A：虛擬區域網路 (推薦新手)
這是最簡單的方法，將網際網路模擬成區域網路。
1.  下載 **Radmin VPN** (免費) 或 **Hamachi**。
2.  您與朋友都安裝並加入同一個群組。
3.  軟體會給您一個特殊的 IP (例如 `26.155.x.x`)。
4.  **Host**: 啟動遊戲，按建立主機。
5.  **Client**: 輸入 Host 在 Radmin 上的那個 IP。
6.  **成功！**

#### 方法 B：端口轉發 (Port Forwarding)
這是正規的架站方式。
1.  進入您的路由器後台設定。
2.  設定將 `7777` 端口的資料，全部轉發給您的電腦 IP。
3.  查出您的真實公網 IP (Google "what is my ip")。
4.  朋友輸入您的**真實公網 IP** 即可連線。

#### 方法 C：使用 Ngrok (臨時測試)
1.  安裝 Ngrok。
2.  執行 `ngrok tcp 7777`。
3.  Ngrok 會給您一個網址 (如 `0.tcp.ngrok.io:12345`)。
4.  朋友輸入該網址對應的 IP 與 Port 即可。

### 總結
`Lobby.gd` 就像是一台設計完美的電話機。
*   **程式碼 (電話機)**：功能正常，隨時準備通話。
*   **網路環境 (電話線)**：如果電話線沒接通 (防火牆擋住、IP 找不到)，電話機再好也打不通。

所以，只要解決網路環境問題 (使用 VPN 或開 Port)，這份程式碼就能立刻支援全球連線。
